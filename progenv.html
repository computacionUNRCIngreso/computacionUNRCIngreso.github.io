<!DOCTYPE html>
<html lang="es">
<head>
    <title>Ambiente de programación</title>
    <meta charset="utf-8"></meta>

    <script src="lib/jquery/jquery-3.1.1.min.js"></script>

    <script type="text/javascript" src="lib/w2ui.min.js"></script>
    <script type="text/javascript" src="lib/es-es.js"></script>

    <link rel="stylesheet" type="text/css" href="css/w2ui.min.css"/>

    <link rel="stylesheet" href="lib/CodeMirror/lib/codemirror.css">
    <script src="lib/CodeMirror/lib/codemirror.js"></script>
    <script src="lib/CodeMirror/mode/javascript/javascript.js"></script>

    <script src="actividades.js"></script>
</head>
<body>

<div id="mainLayout" style="width: 100%; height: 600px;"></div>

<script type="text/javascript">
var editor = null,
    currentActivity = -1,
    db;

function getStore() {
    return db.transaction('actividades', 'readwrite').objectStore('actividades');
}

// guarda la actividad en la BD
function save() {
    var store = getStore();
    var request = store.get(actividades[currentActivity].actividad);

    request.onsuccess = function(event) {
        var data = event.target.result;
        if (!data) {
            data = {
                actividad: actividades[currentActivity].actividad,
                programa: editor.getValue()
            };
            var request = store.add(data);
            request.onerror = function() {
                console.log('Error updating activity on DB');
            };
            request.onsuccess = function() {
                console.log('Actividad guardada con éxito...');
            };
        } else {
            data.programa = editor.getValue();
            var request = store.put(data);
            request.onerror = function() {
                console.log('Error updating activity on DB');
            };
            request.onsuccess = function() {
                console.log('Actividad guardada con éxito...');
            };
        }
    };
}

function openDB() {
    var request = indexedDB.open('progenvDB');

    console.log('In openDB()');
    request.onupgradeneeded = function(event) {
        db = event.target.result;
        console.log('creando object store "actividades", ' + db);
        db.createObjectStore('actividades', {keyPath:'actividad'});
    };

    request.onsuccess = function(event) {
        db = this.result;
        console.log('DB opened successfull');
    };

    request.onerror = function() {
        console.log('Error opening database');
    };
};

openDB();

function addEditor() {
    editor = CodeMirror($('#editor')[0], {
        value: '// Editar su código aquí',
        mode: 'javascript',
        linenumbers: true
    });
}

function setActividad(n) {
    currentActivity = n;
    if (!editor) {
        addEditor();
    }

    var store = getStore(),
        request = store.get(actividades[n].actividad);

    request.onsuccess = function(event) {
        var data = event.target.result;
        if (data) {
            editor.setValue(data.programa);
        }
    };
    request.onerror = function(event) {
        console.log('Error cargando actividad desde la BD');
    };
}

function runProgram() {
    // to do...
}

// On document ready...
$(function () {
    var pstyle = 'background-color: #F5F6F7; border: 1px solid #dfdfdf; padding: 5px;',
        display = '<div id="tabshdr"></div><div id="tab-content" style="position: relative;">' +
                  '<div id="textconsole" width="100%" height="100%" ' +
                  'style="position: absolute; top:0; left:0; display: none">Bienvenido</div>' +
                  '<canvas id="canvas" width="100%" height="100%" ' +
                  'style="position: absolute; top:0; left:0;"></canvas></div>';

    $('#mainLayout').w2layout({
        name: 'layout',
        panels: [
            { type: 'top',  size: 50, resizable: true, style: pstyle,
              content: '<h2>Departamento de Computación - FCEFQyN - UNRC</h2>' },
            { type: 'left', size: 150, resizable: true, style: pstyle },
            { type: 'main', size: '50%', style: pstyle},
            { type: 'preview', size: '25%', resizable: true, style: pstyle, content: 'Doc' },
            { type: 'right', size: '50%', resizable: true, style: pstyle, content: display },
            { type: 'bottom', size: 50, resizable: true, style: pstyle, content: 'bottom' }
        ]
    });

    // Sidebar: actividades
    w2ui.layout.content('left', $().w2sidebar({
        name: 'actividades',
        nodes: [
            {
                id: 'act', text: 'Actividades', img: 'icon-folder', expanded: true,
                nodes: [
                    // to do: A este arreglo hay que llenarlo con las actividades...
                    {id: 'actividad1', text: 'Actividad 1', img: 'icon-page',
                     onClick: function(){setActividad(0);} },
                    {id: 'actividad2', text: 'Actividad 2', img: 'icon-page',
                     onClick: function(){setActividad(1);} }
                ]
            }
        ]
    }));

    // main panel (editor)
    w2ui.layout.content('main', $().w2layout({
        name: 'editorlayout',
        panels: [
            { type: 'top',  name: 'editortop', size: 40,
              style: 'padding: 2px; border: 1px solid #dfdfdf; border-radius: 5px',
              content: $().w2toolbar({
                  name: 'editortoolbar',
                  items: [
                      { type: 'button', text: 'Guardar', img: 'icon-save',
                        onClick: function() {save();}
                      },
                      { type: 'button', text: 'Ejecutar', img: 'icon-reload',
                        onClick: function() {runProgram();}
                      }
                  ]
              })},
            { type: 'main', name: 'editormain', size: '100%',
              style: 'padding: 2px; border: 1px solid #dfdfdf; border-radius: 5px',
              content: '<div id="editor" width="100%" height="100%"></div>'
            }
        ]
    }));

    // display (tabs for canvas and text console)
    $('#tabshdr').w2tabs({
    	name: 'tabs',
    	active: 'lienzo',
    	tabs: [
    		{ id: 'lienzo', caption: 'Lienzo'},
    		{ id: 'consola', caption: 'Consola'},
    	],
    	onClick: function (event) {
            switch(event.target) {
                case 'lienzo':
                    $('#textconsole').hide();
                    $('#canvas').show();
                    break;
                case 'consola':
                    $('#canvas').hide();
                    $('#textconsole').show();
                    break;
            }
    	}
    });
});
</script>

<script id="api" type="text/javascript"></script>
</body>
</html>
